<html>

<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="css/main.css">
	<link rel="icon" type="image/png" href="favicon.png">
</head>

<body>
	<div class="navbar-fixed">
		<nav>
			<div class="nav-wrapper">
				<a href="#" class="brand-logo"><i class="material-icons">cloud</i>SaaS API - Create and distribute your endpoints</a>
				<span href="#" class=" brand-logo right">Editing: <span id="selected-table">-</span></span>
			</div>
		</nav>
	</div>
	<div class="row" id="content">
		<form class="col s4 panel">
			<div class="row">
				<div class="input-field col s10">
					<input id="entity-name" type="text" class="validate" name="entity-name" />
					<label for="entity-name">Endpoint Name</label>
				</div>
				<div class="input-field col s2 floating-button-container">
					<a class="btn-floating btn-large waves-effect waves-light red" id="new-entity"><i class="material-icons">add</i></a>
				</div>
				<div class="col s12">
					<h4>Endpoints</h4>
					<ul class="collection with-header" id="entities">
					</ul>
				</div>
			</div>
		</form>
		<form class="col s8">
			<table id="entity-table" class="bordered highlight">
				<thead>
				</thead>
				<tbody>
				</tbody>
			</table>
		</form>
		<script src="js/jquery-3.0.0.min.js"></script>
		<script src="js/yawp.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/js/materialize.min.js"></script>
		<script>
			$(document).ready(function() {
				var loadedEntities = {};
				var selectedTable;
				var select = '<select>' +
					'<option value="INTEGER">Inteiro</option>' +
					'<option value="STRING">String</option>' +
					'<option value="TEXT">Texto</option>' +
					'<option value="DECIMAL">Decimal</option>' +
					'<option value="BOOLEAN">Boolean</option>' +
					'</select>';
				var getLi = function(entity) {
					return '<li class="collection-item" data-id="' + entity.id + '">' +
						'<div><span class="entity-name">' + entity.name + '</span>' +
						'<a href="#!" class="secondary-content remove-endpoint"><i class="material-icons">delete_forever</i></a>' +
						'<a href="#!" class="secondary-content edit-endpoint"><i class="material-icons">edit</i></a>' +
						'</div>';
				};
				var getHeaderColumn = function(entity) {
					return '';
				};
				var getHeaderActions = function(entity) {
					return '';
				};
				var getTableColumn = function(entity, column) {
					return '<td><input value="' + (entity[column] || '') + '" ' + (column == 'id' ? 'disabled="disabled"' : '') + '"/></td>';
				};
				var getTableActions = function() {
					return '<td><button class="edit-line">Salvar</button><button class="remove-line">Remove</button></td>';
				};
				var getTableAddLine = function(colspan) {
					return '<tr><td colspan="' + colspan + '" class="centered"><a class="btn-floating btn-large waves-effect waves-light red add-line"><i class="material-icons">add</i></a></td></tr>';
				};
				yawp('/entities').list(function(entities) {
					var list = '';
					loadedEntities = {};
					for (var i = 0; i < entities.length; i++) {
						list += getLi(entities[i]);
						loadedEntities[entities[i].id] = entities[i];
					}
					$('#entities').html(list);
				});

				$('#new-entity').click(function() {
					var name = $('[name="entity-name"]').val();
					if (!name) {
						return;
					}
					yawp('/entities').create({
						name: name
					}).done(function(entity) {
						loadedEntities[entity.id] = entity;
						$('#entities').append(getLi(entity));
						$('[name="entity-name"]').val('').blur();
					});
				});
				$('#entities').on('click', '.edit-endpoint', function() {
					var li = $(this).parents('li'),
						id = li.data('id');
					selectedTable = loadedEntities[id];
					$('#selected-table').html(li.find('.entity-name').text());
					var columns = selectedTable.properties || [];
					var columnsText = '<tr>';
					for (var i = 0; i < columns.length; i++) {
						columnsText += '<th>' + columns[i].name + '</th>';
					}
					columnsText += '<td> <div class="row"><input class="column-name s4"/>' +
						'<input class="column-default  s4"/>' +
						'' + select + '<button class="add-column">+</button></div></td></tr>';
					$('#entity-table thead').html(columnsText);

					$.ajax({
						type: 'GET',
						url: '/api/' + selectedTable.name,
						dataType: 'json'
					}).done(function(instances) {
						var table = $('#entity-table tbody');
						var lines = '';
						for (var i = 0; i < instances.length; i++) {
							lines += newLine(instances[i]);
						}
						lines += getTableAddLine(columns.length + 1);
						table.html(lines);
					});
				}).on('click', '.remove-endpoint', function() {
					var li = $(this).parents('li');
					yawp(li.data('id')).destroy();
					li.remove();
				});

				var newLine = function(instance) {
					var newLine = '<tr>',
						header = $('#entity-table thead > tr > td:not(:last-child)');
					header.each(function() {
						newLine += getTableColumn(instance, $(this).text());
					});
					newLine += getTableActions();
					return newLine + '</tr>';
				};
				$('#entity-table').on('click', '.add-column', function() {
					selectedTable.properties = selectedTable.properties || [];
					selectedTable.properties.push({
						type: $(this).parent().find('select').val(),
						name: $(this).parent().find('.column-name').val(),
						defaultValue: $(this).parent().find('.column-default').val()
					});
					yawp(selectedTable.id).update(selectedTable).done(function(updatedEntity) {
						loadedEntities[selectedTable.id] = updatedEntity;
						$('li[data-id="' + updatedEntity.id + '"] .edit-entity').click();
					});
				}).on('click', '.add-line', function() {
					$.ajax({
						url: '/api/' + selectedTable.name,
						type: 'POST',
						data: {}
					}).done(function(instance) {
						$(newLine(instance)).insertBefore($('#entity-table tbody tr:last'));
					});
				}).on('click', '.edit-line', function() {
					var header = $('#entity-table thead > tr > td:not(:last-child)'),
						columnNumber = 0,
						newObject = {},
						tds = $(this).parents('tr').find('td input');
					header.each(function() {
						newObject[$(this).text()] = tds.eq(columnNumber++).val();
					});
					$.ajax({
						type: 'PUT',
						url: '/api/' + selectedTable.name + '/' + newObject.id,
						dataType: 'json',
						data: {
							instance: JSON.stringify(newObject)
						}
					}).done(function() {
						console.info('uhul');
					});
				}).on('click', '.remove-line', function() {
					var tr = $(this).parents('tr');
					$.ajax({
						type: 'DELETE',
						url: '/api/' + selectedTable.name + '/' + tr.find('td:first-child input').val()
					}).done(function() {
						tr.remove();
					})
				});
			});
		</script>
</body>

</html>
